#!/usr/bin/env node

/**
 * Initialize ADB connection to living room TV only
 * This script is called during Bernard startup
 */

const { execSync, spawn } = require('child_process');
const fs = require('fs');
const path = require('path');
const os = require('os');

async function initializeLivingRoomAdb() {
  console.log('ðŸ”§ Initializing ADB connection to living room TV...');

  // Check if ADB is available
  try {
    execSync('which adb', { stdio: 'pipe' });
  } catch (error) {
    console.log('ADB not installed - skipping ADB initialization, will use HA fallback');
    return;
  }

  try {
    // Generate ADB keys if needed (using Redis from the compiled app)
    console.log('Checking/generating ADB keys...');

    // For now, just use basic ADB setup without Redis dependency
    // The keys will be generated on-demand by the tool

    // Kill any existing server and start fresh
    try {
      console.log('Restarting ADB server...');
      execSync('adb kill-server', { timeout: 5000, stdio: 'pipe' });
      await new Promise(resolve => setTimeout(resolve, 1000));
      execSync('adb start-server', { timeout: 5000, stdio: 'pipe' });
      await new Promise(resolve => setTimeout(resolve, 2000));
    } catch (serverError) {
      console.warn('ADB server restart failed:', serverError.message);
    }

    // Connect to living room TV only
    const livingRoomAddress = '10.97.1.90:5555';
    console.log(`Connecting to living room TV at ${livingRoomAddress}...`);

    // Attempt connection
    const connectResult = execSync(`adb connect ${livingRoomAddress}`, {
      timeout: 10000,
      encoding: 'utf8',
      stdio: 'pipe'
    });
    console.log(`ADB connect result: ${connectResult.trim()}`);

    // Wait for connection
    await new Promise(resolve => setTimeout(resolve, 3000));

    // Verify connection
    const devicesResult = execSync('adb devices', {
      timeout: 5000,
      encoding: 'utf8',
      stdio: 'pipe'
    });
    console.log(`ADB devices: ${devicesResult.trim()}`);

    if (devicesResult.includes(livingRoomAddress) && !devicesResult.includes('offline')) {
      console.log('âœ… Living room TV ADB connection established successfully');

      // Test communication with a simple command
      try {
        // Create temporary key file for testing (keys will be generated by the tool when needed)
        const testResult = execSync(`adb -s ${livingRoomAddress} shell "echo 'ADB ready'"`, {
          timeout: 5000,
          encoding: 'utf8',
          stdio: 'pipe'
        });

        if (testResult.includes('ADB ready')) {
          console.log('âœ… Living room TV ADB communication verified');
        } else {
          console.log('âš ï¸  Living room TV connected but test communication failed');
        }
      } catch (testError) {
        console.log('âš ï¸  Living room TV connected but test communication failed:', testError.message);
      }
    } else {
      console.log('âš ï¸  Living room TV ADB connection failed - will use HA fallback');
    }

  } catch (error) {
    console.error('Failed to initialize living room ADB connection:', error.message);
    console.log('Will use HA fallback for living room TV control');
  }

  console.log('ðŸ  Bedroom TV ADB connection deliberately skipped (wife sleeping) ðŸ›Œ');
}

// Run the initialization
initializeLivingRoomAdb().catch(error => {
  console.error('ADB initialization failed:', error);
  process.exit(1);
});
