<section class="models">
  <div class="section-header">
    <div>
      <h1>Models</h1>
      <p class="muted">Configure providers and model settings for each harness.</p>
    </div>
    <div class="actions">
      <button pButton type="button" label="Reload" icon="pi pi-refresh" (click)="load()" [disabled]="loading()" severity="secondary"></button>
      <button pButton type="button" label="Save" icon="pi pi-save" (click)="save()" [loading]="saving()" [disabled]="loading()"></button>
    </div>
  </div>

  @if (error()) {
    <p-message severity="error" [text]="error() ?? ''" styleClass="w-full"></p-message>
  }

  @if (testingError()) {
    <p-message severity="warn" [text]="testingError() ?? ''" styleClass="w-full"></p-message>
  }

  @if (loading()) {
    <p class="muted">Loading model settingsâ€¦</p>
  } @else {
    <!-- Provider Section -->
    <div class="provider-section">
      <div class="provider-header">
        <h2>Providers</h2>
        <p class="muted">Configure your model providers (OpenRouter, OpenAI-compatible APIs)</p>
      </div>

      <div class="provider-actions">
        <button pButton label="Add Provider" icon="pi pi-plus" (click)="addProvider()"></button>
      </div>

      <div class="provider-list">
        @for (provider of providers(); track provider.id) {
          <div class="provider-card" [class.failed]="provider.testStatus === 'failed'">
            <div class="provider-info">
              <h3>{{ provider.name }}</h3>
              <p class="url">{{ provider.baseUrl }}</p>
              <div class="status-row">
                <span class="status-badge" [class.working]="provider.testStatus === 'working'"
                                      [class.failed]="provider.testStatus === 'failed'"
                                      [class.untested]="!provider.testStatus">
                  {{ provider.testStatus || 'Untested' }}
                </span>
                @if (provider.lastTestedAt) {
                  <span class="last-tested">Last tested: {{ provider.lastTestedAt | date:'short' }}</span>
                }
              </div>
            </div>
            <div class="provider-actions">
              <button pButton icon="pi pi-refresh" severity="secondary"
                      (click)="testProvider(provider)" [loading]="testingProvider() === provider.id"
                      [disabled]="testingProvider() && testingProvider() !== provider.id">
                Test
              </button>
              <button pButton icon="pi pi-pencil" severity="secondary"
                      (click)="editProvider(provider)"></button>
              <button pButton icon="pi pi-trash" severity="danger"
                      (click)="deleteProvider(provider)" [disabled]="isProviderInUse(provider.id)"></button>
            </div>
          </div>
        }

        @if (!providers().length) {
          <p class="muted">No providers configured. Add a provider to get started.</p>
        }
      </div>
    </div>

    <!-- Models Section -->
    <div class="models-section">
      <div class="models-header">
        <h2>Model Configuration</h2>
        <p class="muted">Configure which models to use for each harness</p>
      </div>

      <form [formGroup]="form">
        <div class="model-rows">
          @for (category of categories; track category.key) {
            <div class="model-row">
              <div class="row-header">
                <h3>{{ category.label }}</h3>
                <p class="description">{{ category.description }}</p>
              </div>

              <div class="row-content" [formGroupName]="category.key">
                <!-- Provider Selection -->
                <div class="field provider-field">
                  <label class="label">Provider</label>
                  <p-dropdown [options]="providerOptions()" formControlName="providerId"
                             [disabled]="!providers().length" placeholder="Select provider">
                  </p-dropdown>
                  <p-message *ngIf="!providers().length" severity="warn"
                            text="Add a provider first to configure models"></p-message>
                </div>

                <!-- Model Selection -->
                <div class="field model-field">
                  <label class="label">Model</label>
                  <p-autoComplete formControlName="primary"
                                 [suggestions]="getModelSuggestions(category.key)"
                                 (completeMethod)="fetchModelsForProvider($event, form.get(category.key)?.get('providerId')?.value ?? '')"
                                 [disabled]="!(form.get(category.key)?.get('providerId')?.value) || !isProviderWorking(form.get(category.key)?.get('providerId')?.value ?? '')"
                                 placeholder="Select a model">
                  </p-autoComplete>
                  <p-message *ngIf="form.get(category.key)?.get('providerId')?.value && !isProviderWorking(form.get(category.key)?.get('providerId')?.value ?? '')" severity="warn"
                            text="Provider is not working. Test the provider connection first."></p-message>
                </div>

                <!-- Parameters Row -->
                <div class="parameters-row">
                  <div class="param-field">
                    <label class="label">Temperature</label>
                    <input pInputText type="number" step="0.1" min="0" max="2"
                           formControlName="temperature">
                  </div>
                  <div class="param-field">
                    <label class="label">Top P</label>
                    <input pInputText type="number" step="0.05" min="0" max="1"
                           formControlName="topP">
                  </div>
                  <div class="param-field">
                    <label class="label">Max Tokens</label>
                    <input pInputText type="number" min="1"
                           formControlName="maxTokens">
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </form>
    </div>
  }

  <!-- Add Provider Dialog -->
  <p-dialog header="Add Provider" [visible]="showAddProviderDialog()" [modal]="true" [style]="{width: '50vw'}" (onHide)="showAddProviderDialog.set(false)">
    <div class="provider-form">
      <div class="field">
        <label class="label">Name</label>
        <input pInputText [formGroup]="providerForm" formControlName="name" placeholder="e.g., OpenRouter">
      </div>
      <div class="field">
        <label class="label">Base URL</label>
        <input pInputText [formGroup]="providerForm" formControlName="baseUrl" placeholder="https://openrouter.ai/api/v1">
      </div>
      <div class="field">
        <label class="label">API Key</label>
        <input pInputText type="password" [formGroup]="providerForm" formControlName="apiKey" placeholder="sk-****">
      </div>
    </div>
    <ng-template pTemplate="footer">
      <div class="dialog-actions">
        <button pButton type="button" label="Cancel" icon="pi pi-times" (click)="showAddProviderDialog.set(false)" severity="secondary"></button>
        <button pButton type="button" label="Save" icon="pi pi-save" (click)="saveProvider()"></button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Edit Provider Dialog -->
  <p-dialog header="Edit Provider" [visible]="showEditProviderDialog()" [modal]="true" [style]="{width: '50vw'}" (onHide)="showEditProviderDialog.set(false)">
    <div class="provider-form">
      <div class="field">
        <label class="label">Name</label>
        <input pInputText [formGroup]="providerForm" formControlName="name" placeholder="e.g., OpenRouter">
      </div>
      <div class="field">
        <label class="label">Base URL</label>
        <input pInputText [formGroup]="providerForm" formControlName="baseUrl" placeholder="https://openrouter.ai/api/v1">
      </div>
      <div class="field">
        <label class="label">API Key</label>
        <input pInputText type="password" [formGroup]="providerForm" formControlName="apiKey" placeholder="sk-****">
      </div>
    </div>
    <ng-template pTemplate="footer">
      <div class="dialog-actions">
        <button pButton type="button" label="Cancel" icon="pi pi-times" (click)="showEditProviderDialog.set(false)" severity="secondary"></button>
        <button pButton type="button" label="Save" icon="pi pi-save" (click)="saveProvider()"></button>
      </div>
    </ng-template>
  </p-dialog>
</section>