<section class="conversation">
  <div class="topbar">
    <button
      pButton
      type="button"
      icon="pi pi-arrow-left"
      label="Back"
      aria-label="Back to history"
      (click)="back()"
      [text]="true"
    ></button>
    <div class="title" [pTooltip]="idTooltip()" tooltipPosition="bottom">
      <h1>{{ conversation()?.source || 'Conversation' }}</h1>
    </div>
    <div class="topbar-meta">
      <span class="last-request">
        @if (lastRequestAt(); as lastRequest) {
          {{ lastRequest | date: 'short' }}
        } @else {
          &mdash;
        }
      </span>
      <span
        class="status-dot"
        [class.active]="isActive()"
        role="status"
        [attr.aria-label]="isActive() ? 'Conversation is active' : 'Conversation is closed'"
      ></span>
    </div>
  </div>

  @if (error()) {
    <p-message severity="error" [text]="error() ?? ''" styleClass="w-full"></p-message>
  }

  <div class="messages" [class.loading]="loading()">
    @if (loading()) {
      <div class="skeleton" aria-hidden="true"></div>
      <div class="skeleton" aria-hidden="true"></div>
    } @else {
      @if (!messages().length) {
        <p class="muted">No messages yet.</p>
      } @else {
        <div class="thread">
          @for (turn of turns(); track turn.index) {
            <div class="turn-block">
              <div class="turn-separator" [attr.aria-label]="'Turn ' + turn.index">
                <span class="turn-label">Turn {{ turn.index }}</span>
                @if (turn.durationLabel) {
                  <span class="turn-duration">â€¢ {{ turn.durationLabel }}</span>
                }
              </div>
              @for (item of turn.items; track item.id) {
                <div class="thread-row">
                  @switch (item.kind) {
                    @case ('llm-call') {
                      <app-llm-call [trace]="item.trace" [createdAt]="item.createdAt"></app-llm-call>
                    }
                    @case ('error') {
                      <div class="error-separator" [class.expanded]="isErrorExpanded(item.id)">
                        <button
                          type="button"
                          class="error-toggle"
                          (click)="toggleError(item.id)"
                          [attr.aria-expanded]="isErrorExpanded(item.id)"
                          [attr.aria-controls]="'error-body-' + item.id"
                        >
                          <span class="pi pi-chevron-down chevron" [class.expanded]="isErrorExpanded(item.id)"></span>
                          <span class="error-label">{{ item.message.name || 'Error' }}</span>
                          <span class="error-preview">{{ errorPreview(item.message) }}</span>
                          <span class="error-timestamp">{{ messageFooter(item.message) }}</span>
                        </button>
                        @if (isErrorExpanded(item.id)) {
                          <div class="error-body" [id]="'error-body-' + item.id">
                            <div class="error-text">{{ renderContent(item.message) }}</div>
                            <div class="error-solutions">
                              <span class="solutions-title">Possible fixes</span>
                              <ul>
                                @for (hint of errorSolutions(item.message); track hint) {
                                  <li>{{ hint }}</li>
                                }
                              </ul>
                            </div>
                          </div>
                        }
                      </div>
                    }
                    @case ('user') {
                      <app-user-message-bubble
                        [text]="renderContent(item.message)"
                        [footer]="messageFooter(item.message)"
                      />
                    }
                    @case ('assistant-text') {
                      <app-assistant-message-bubble
                        [text]="renderContent(item.message)"
                        [footer]="messageFooter(item.message)"
                      />
                    }
                    @case ('system') {
                      <app-system-message-bubble
                        [text]="renderContent(item.message)"
                        [footer]="messageFooter(item.message)"
                      />
                    }
                    @case ('tool-interaction') {
                      <app-tool-call-bubble
                        [call]="item.call"
                        [name]="item.name || null"
                        [content]="toolInteractionContent(item.response)"
                        [footer]="toolInteractionFooter(item)"
                      ></app-tool-call-bubble>
                    }
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    }
  </div>

  <div class="conversation-actions" aria-live="polite">
    <button
      pButton
      type="button"
      [icon]="copyButtonIcon()"
      [label]="copyButtonLabel()"
      [disabled]="!transactionJson() || loading()"
      (click)="copyTransaction()"
    ></button>
    @if (copyStatus() !== 'idle') {
      <span
        class="copy-status"
        [class.success]="copyStatus() === 'success'"
        [class.error]="copyStatus() === 'error'"
        role="status"
      >
        {{ copyStatusText() }}
      </span>
    }
  </div>

  <div class="metadata">
    <div class="panel">
      <h3>Summary</h3>
      <p>{{ conversation()?.summary || 'No summary yet.' }}</p>
    </div>

    <div class="panel grid">
      <div>
        <h4>Tags</h4>
        @if (!conversation()?.tags?.length) {
          <p class="muted">None</p>
        } @else {
          <div class="tag-list">
            @for (tag of conversation()?.tags ?? []; track tag) {
              <p-tag [value]="tag" severity="info"></p-tag>
            }
          </div>
        }
      </div>

      <div>
        <h4>Flags</h4>
        @if (!conversation()?.flags) {
          <p class="muted">None</p>
        } @else {
          <div class="flag-list">
            <p-tag [value]="'Explicit'" [severity]="conversation()?.flags?.explicit ? 'danger' : 'success'"></p-tag>
            <p-tag [value]="'Forbidden'" [severity]="conversation()?.flags?.forbidden ? 'danger' : 'success'"></p-tag>
            @if (conversation()?.flags?.summaryError) {
              <p-tag value="Summary error" severity="warning"></p-tag>
            }
          </div>
        }
      </div>

      <div class="meta-grid">
        <div class="meta-row">
          <span class="label">Models</span>
          <span class="value">{{ (conversation()?.modelSet ?? ['n/a']).join(', ') }}</span>
        </div>
        <div class="meta-row">
          <span class="label">Tokens</span>
          <span class="value">{{ (conversation()?.tokenNames ?? ['Unknown']).join(', ') }}</span>
        </div>
        <div class="meta-row">
          <span class="label">Places</span>
          <span class="value">{{ (conversation()?.placeTags ?? ['n/a']).join(', ') }}</span>
        </div>
        <div class="meta-row">
          <span class="label">Keywords</span>
          <span class="value">{{ (conversation()?.keywords ?? ['n/a']).join(', ') }}</span>
        </div>
        <div class="meta-row">
          <span class="label">Started</span>
          <span class="value">{{ conversation()?.startedAt | date: 'short' }}</span>
        </div>
        <div class="meta-row">
          <span class="label">Last touched</span>
          <span class="value">{{ conversation()?.lastTouchedAt | date: 'short' }}</span>
        </div>
        <div class="meta-row">
          <span class="label">Close reason</span>
          <span class="value">{{ conversation()?.closeReason || 'n/a' }}</span>
        </div>
      </div>
    </div>
  </div>
</section>
