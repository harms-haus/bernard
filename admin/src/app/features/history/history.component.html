<section class="history">
  <div class="section-header">
    <div>
      <h1>History</h1>
      <p class="muted">Monitor active and recent conversations.</p>
    </div>
    <div class="actions">
      <p-tag [value]="'Active: ' + stats().active" severity="success"></p-tag>
      <p-tag [value]="'Total: ' + stats().total" severity="secondary"></p-tag>
      <button pButton type="button" icon="pi pi-refresh" label="Refresh" (click)="load()" [loading]="loading()"></button>
    </div>
  </div>

  @if (error()) {
    <p-message severity="error" [text]="error() ?? ''" styleClass="w-full"></p-message>
  }

  <p-table [value]="conversations()" [loading]="loading()" responsiveLayout="stack" [rowHover]="true">
    <ng-template pTemplate="header">
       <tr>
         <th>Status</th>
         <th>Source</th>
         <th>Summary</th>
         <th>Messages</th>
         <th>Tool calls</th>
         <th>Max turn</th>
         <th>Indexing</th>
         <th></th>
       </tr>
    </ng-template>
    <ng-template pTemplate="body" let-convo>
      <tr
        (keydown.enter)="navigateFromKey($event, convo)"
        (keydown.space)="navigateFromKey($event, convo)"
        tabindex="0"
        [class.active]="convo.status === 'open'"
      >
        <td>
          <div class="status-cell">
            <p-tag [value]="statusLabel(convo.status)" [severity]="convo.status === 'open' ? 'success' : 'secondary'"></p-tag>
            @if (convo.status === 'closed' && hasErrors(convo)) {
              <span class="status-error" title="Errors in conversation" aria-label="Conversation has errors">
                <i class="pi pi-exclamation-triangle"></i>
              </span>
            }
          </div>
        </td>
        <td>
          <div class="source">
            <span class="source-name"><a (click)="open(convo)">{{ convo.source }}</a></span>
            @if (convo.tokenNames.length > 1) {
              <span class="muted">+{{ convo.tokenNames.length - 1 }} more</span>
            }
          </div>
        </td>
        <td>
          <div class="summary">{{ convo.summary || 'No summary yet' }}</div>
        </td>
        <td>{{ messageCount(convo) }}</td>
        <td>{{ convo.toolCallCount }}</td>
         <td>{{ formatLatencyMs(convo.maxTurnLatencyMs) }}</td>
         <td>
           <div class="indexing-status">
             <p-tag 
               [value]="indexingStatusLabel(convo.indexingStatus)" 
               [severity]="indexingStatusSeverity(convo.indexingStatus)" 
               [icon]="indexingStatusIcon(convo.indexingStatus)"
             ></p-tag>
             @if (convo.indexingError) {
               <i class="pi pi-info-circle error-tooltip" 
                  pTooltip="{{ convo.indexingError }}" 
                  tooltipPosition="top"
               ></i>
             }
           </div>
         </td>
         <td class="actions">
          <p-menu #menu [model]="menuItems(convo)" [popup]="true" appendTo="body"></p-menu>
          @if (convo.status === 'open') {
            <button
              pButton
              type="button"
              label="Close"
              icon="pi pi-stop"
              severity="warning"
              (click)="closeConversation(convo)"
              [loading]="closingId() === convo.id"
              [disabled]="deletingId() === convo.id"
              text
            ></button>
          }
          <button
            pButton
            type="button"
            icon="pi pi-ellipsis-v"
            aria-label="Conversation actions"
            (click)="menu.toggle($event)"
            [disabled]="deletingId() === convo.id || closingId() === convo.id"
            text
          ></button>
        </td>
      </tr>
    </ng-template>
     <ng-template pTemplate="emptymessage">
       <tr>
         <td colspan="8">No history yet.</td>
       </tr>
     </ng-template>
  </p-table>

  <p-dialog
    header="Delete conversation"
    [visible]="confirmVisible()"
    [modal]="true"
    [closable]="false"
    [dismissableMask]="true"
    [style]="{ width: '420px' }"
    (onHide)="cancelDelete()"
  >
    <p>
      Delete conversation from "{{ pendingConversation()?.source || 'unknown' }}"? This cannot be undone.
    </p>
    <div class="dialog-actions">
      <button pButton type="button" label="Cancel" severity="secondary" (click)="cancelDelete()" text></button>
      <button
        pButton
        type="button"
        label="Delete"
        severity="danger"
        (click)="confirmDelete()"
        [loading]="deletingId() === pendingConversation()?.id"
      ></button>
    </div>
  </p-dialog>
</section>
