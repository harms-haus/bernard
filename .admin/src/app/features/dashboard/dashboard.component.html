<section class="dashboard">
  <div class="section-header">
    <div>
      <h1>Dashboard</h1>
      <p class="muted">Live view of Bernard health, uptime, and workload.</p>
    </div>
    <div class="actions">
      <p-tag [value]="status()?.status ?? 'unknown'" [severity]="statusSeverity(status())"></p-tag>
      <button
        pButton
        type="button"
        icon="pi pi-refresh"
        label="Refresh"
        [disabled]="loading()"
        (click)="refresh()"
        severity="secondary"
      ></button>
    </div>
  </div>

  @if (error()) {
    <p-message severity="error" [text]="error() ?? ''" styleClass="w-full"></p-message>
  }

  @if (loading()) {
    <div class="loading-grid">
      <p-skeleton width="100%" height="160px"></p-skeleton>
      <p-skeleton width="100%" height="160px"></p-skeleton>
      <p-skeleton width="100%" height="240px"></p-skeleton>
    </div>
  } @else {
    <div class="stats-grid">
      <p-card class="stat-card status-card">
        <div class="status-row">
          <p-tag [value]="status()?.status ?? 'unknown'" [severity]="statusSeverity(status())"></p-tag>
          <span class="muted">Version {{ status()?.version ?? 'n/a' }}</span>
        </div>
        <div class="metrics">
          <div class="metric">
            <span class="label">Uptime</span>
            <span class="value">{{ uptimeText() }}</span>
          </div>
          <div class="metric">
            <span class="label">Active conversations</span>
            <span class="value">{{ status()?.activeConversations ?? 0 }}</span>
          </div>
          <div class="metric">
            <span class="label">Active tokens</span>
            <span class="value">{{ status()?.tokensActive ?? 0 }}</span>
          </div>
          <div class="metric">
            <span class="label">Queue</span>
            <span class="value">{{ status()?.queueSize ?? 0 }}</span>
          </div>
          <div class="metric">
            <span class="label">Last message</span>
            <span class="value">{{ lastSeen() }}</span>
          </div>
          <div class="metric">
            <span class="label">Uptime (30d)</span>
            <span class="value">{{ uptimePercent() }}%</span>
          </div>
        </div>
        @if (status()?.notes) {
          <p class="muted note">{{ status()?.notes }}</p>
        }
      </p-card>

      <p-card class="stat-card">
        <p class="label">Requests today</p>
        <div class="stat-value">{{ trafficSummary().requestsToday }}</div>
        <p class="muted">
          This week: {{ trafficSummary().requestsWeek }} • Errors: {{ trafficSummary().errorsToday }}
        </p>
        <div class="sparkline" role="img" aria-label="Requests over the last 12 hours">
          @for (height of sparklinePercents(); track $index) {
            <span class="spark-bar" [style.height.%]="height"></span>
          }
        </div>
      </p-card>

      <p-card class="stat-card">
        <p class="label">Success rate</p>
        <div class="stat-value">{{ trafficSummary().successRate }}%</div>
        <p class="muted">
          Latency p50: {{ latency()[0]?.value }} ms • p95: {{ latency()[2]?.value }} ms
        </p>
        <div class="pill-row">
          <p-tag [value]="'Active tokens: ' + (status()?.tokensActive ?? 0)" severity="info"></p-tag>
          <p-tag [value]="'Queue: ' + (status()?.queueSize ?? 0)" severity="warning"></p-tag>
        </div>
      </p-card>
    </div>

    <div class="chart-grid">
      <p-card>
        <div class="card-header">
          <div>
            <p class="label">Traffic</p>
            <p class="muted">Requests vs tool calls (last 12 hours)</p>
          </div>
        </div>
        <div class="chart-frame">
          <p-chart type="line" [data]="throughputChartData()" [options]="throughputChartOptions"></p-chart>
        </div>
      </p-card>

      <p-card>
        <div class="card-header">
          <div>
            <p class="label">Model mix</p>
            <p class="muted">Share of routed requests</p>
          </div>
        </div>
        <div class="chart-frame doughnut">
          <p-chart type="doughnut" [data]="modelShareData()" [options]="modelShareOptions"></p-chart>
        </div>
        <div class="legend-list">
          @for (model of modelShare(); track model.label) {
            <div class="legend-item">
              <span class="dot" [style.background]="model.color"></span>
              <span class="legend-label">{{ model.label }}</span>
              <span class="legend-value">{{ model.value }}%</span>
            </div>
          }
        </div>
      </p-card>

      <p-card class="wide-card">
        <div class="card-header">
          <div>
            <p class="label">Latency</p>
            <p class="muted">p50/p90/p95/max (ms)</p>
          </div>
        </div>
        <div class="chart-frame">
          <p-chart type="bar" [data]="latencyChartData()" [options]="latencyChartOptions"></p-chart>
        </div>
      </p-card>
    </div>
  }
</section>
